<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>2048</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#101b33;

      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.14);
      --stroke: rgba(255,255,255,.22);

      --text: rgba(255,255,255,.92);
      --sub: rgba(255,255,255,.70);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;

      --gap: 10px;
      --size: 4;
      --cell: 80px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Noto Sans CJK SC", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 15%, rgba(99,102,241,.35), transparent 55%),
        radial-gradient(900px 700px at 85% 25%, rgba(34,211,238,.22), transparent 60%),
        radial-gradient(1000px 900px at 50% 95%, rgba(16,185,129,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .safe{
      min-height:100%;
      padding:
        calc(16px + env(safe-area-inset-top))
        calc(16px + env(safe-area-inset-right))
        calc(18px + env(safe-area-inset-bottom))
        calc(16px + env(safe-area-inset-left));
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .app{
      width: min(1080px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      padding: 4px 2px;
      flex-wrap:wrap;
    }
    .title{
      margin:0;
      line-height:1.2;
      font-size: clamp(18px, 2.2vw, 22px);
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      font-size: 12px;
      color: var(--sub);
    }

    .panel{
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, var(--card), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .content{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap: 14px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .content{ grid-template-columns: 1fr; }
    }

    .leftWrap{ padding: 14px; display:flex; flex-direction:column; gap: 12px; }
    .rightWrap{ padding: 14px; display:flex; flex-direction:column; gap: 12px; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .chip{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      min-height: 44px;
    }
    .chip b{
      font-size: 12px;
      color: var(--sub);
      font-weight: 650;
      letter-spacing:.2px;
    }
    .chip span{
      font-size: 16px;
      font-weight: 750;
      letter-spacing:.2px;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 14px;
      min-height: 46px;
      outline:none;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.2px;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.34);
      background: rgba(255,255,255,.10);
      box-shadow: 0 14px 34px rgba(0,0,0,.28);
    }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:focus-visible{
      border-color: rgba(255,255,255,.55);
      box-shadow: 0 0 0 4px rgba(99,102,241,.28);
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* =========================
       自绘下拉（替代原生 select）
       ========================= */
    .dropdown{
      position: relative;
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      min-height: 44px;
    }
    .dropdown b{
      font-size: 12px;
      color: var(--sub);
      font-weight: 650;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .ddBtn{
      flex: 1 1 auto;
      min-width: 150px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      min-height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
      color: var(--text);
      outline:none;
      cursor:pointer;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .ddBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.34);
      background: rgba(255,255,255,.10);
      box-shadow: 0 14px 34px rgba(0,0,0,.20);
    }
    .ddBtn:active{ transform: translateY(0px) scale(.99); }
    .ddBtn:focus-visible{
      border-color: rgba(255,255,255,.55);
      box-shadow: 0 0 0 4px rgba(99,102,241,.28);
    }
    .ddValue{
      font-weight: 750;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ddChevron{
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
      opacity:.95;
    }
    .ddChevron svg{
      width: 18px;
      height: 18px;
      fill:none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: transform .16s ease;
    }
    .dropdown.open .ddChevron svg{ transform: rotate(180deg); }

    .ddMenu{
      position:absolute;
      left: 12px;
      right: 12px;
      top: calc(100% + 10px);
      z-index: 50;

      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.22);
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);

      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      overflow:hidden;
      display:none;
    }
    .dropdown.open .ddMenu{ display:block; }

    .ddItem{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      background: transparent;
      border: none;
      color: var(--text);
      cursor:pointer;
      text-align:left;
      font-weight: 650;
      letter-spacing:.2px;
    }
    .ddItem + .ddItem{
      border-top: 1px solid rgba(255,255,255,.12);
    }
    .ddItem:hover{
      background: rgba(255,255,255,.08);
    }
    .ddItem[aria-selected="true"]{
      background: rgba(99,102,241,.16);
    }
    .ddMark{
      width: 18px;
      height: 18px;
      opacity:.0;
    }
    .ddItem[aria-selected="true"] .ddMark{ opacity: .95; }
    .ddMark svg{
      width: 18px;
      height: 18px;
      fill:none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* =========================
       棋盘
       ========================= */
    .boardShell{
      position:relative;
      width: min(520px, 100%);
      margin: 0 auto;
    }
    .board{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      box-shadow: 0 16px 44px rgba(0,0,0,.40);
    }

    .gridBg{
      position:absolute;
      inset: 12px;
      display:grid;
      grid-template-columns: repeat(var(--size), 1fr);
      grid-template-rows: repeat(var(--size), 1fr);
      gap: var(--gap);
      z-index: 1;
    }
    .cell{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }

    .tiles{
      position:absolute;
      inset: 12px;
      z-index: 2;
      pointer-events:none;
    }
    .tile{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 850;
      letter-spacing:.3px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transform: translate(var(--x), var(--y));
      transition: transform 120ms ease, opacity 120ms ease;
      overflow:hidden;
    }
    .tile::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(600px 140px at 10% 0%, rgba(255,255,255,.20), transparent 60%),
        radial-gradient(420px 220px at 100% 0%, rgba(255,255,255,.12), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .tile .n{
      position:relative;
      z-index: 1;
      font-size: clamp(18px, 3.6vw, 34px);
      text-shadow: 0 8px 16px rgba(0,0,0,.35);
    }
    .tile[data-digits="4"] .n{ font-size: clamp(16px, 3.0vw, 28px); }
    .tile[data-digits="5"] .n{ font-size: clamp(14px, 2.6vw, 22px); }

    .tile[data-v="2"]   { background: linear-gradient(135deg, rgba(99,102,241,.30), rgba(255,255,255,.08)); }
    .tile[data-v="4"]   { background: linear-gradient(135deg, rgba(34,211,238,.28), rgba(255,255,255,.08)); }
    .tile[data-v="8"]   { background: linear-gradient(135deg, rgba(16,185,129,.30), rgba(255,255,255,.08)); }
    .tile[data-v="16"]  { background: linear-gradient(135deg, rgba(251,146,60,.30), rgba(255,255,255,.08)); }
    .tile[data-v="32"]  { background: linear-gradient(135deg, rgba(244,63,94,.30), rgba(255,255,255,.08)); }
    .tile[data-v="64"]  { background: linear-gradient(135deg, rgba(168,85,247,.30), rgba(255,255,255,.08)); }
    .tile[data-v="128"] { background: linear-gradient(135deg, rgba(99,102,241,.34), rgba(34,211,238,.16)); }
    .tile[data-v="256"] { background: linear-gradient(135deg, rgba(34,211,238,.34), rgba(16,185,129,.16)); }
    .tile[data-v="512"] { background: linear-gradient(135deg, rgba(16,185,129,.34), rgba(251,146,60,.16)); }
    .tile[data-v="1024"]{ background: linear-gradient(135deg, rgba(251,146,60,.34), rgba(244,63,94,.16)); }
    .tile[data-v="2048"]{ background: linear-gradient(135deg, rgba(168,85,247,.34), rgba(99,102,241,.16)); }

    @keyframes pop {
      0% { transform: translate(var(--x), var(--y)) scale(.92); opacity: .0; }
      100% { transform: translate(var(--x), var(--y)) scale(1); opacity: 1; }
    }
    .tile.pop{ animation: pop 120ms ease-out; }

    .overlay{
      position:absolute;
      inset:0;
      z-index:3;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width: min(420px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.22);
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .overlayCard h3{ margin: 0; font-size: 16px; letter-spacing:.2px; }
    .overlayCard p{ margin: 0; font-size: 12.5px; color: var(--sub); line-height:1.4; }
    .overlayActions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 4px;
    }

    /* 方向按钮 */
    .dpad{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 10px;
      align-items:stretch;
      justify-items:stretch;
      user-select:none;
    }
    .dpad .spacer{ visibility:hidden; }
    .dpadBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 56px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, box-shadow .16s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .dpadBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.34);
      background: rgba(255,255,255,.10);
      box-shadow: 0 14px 34px rgba(0,0,0,.28);
    }
    .dpadBtn:active{ transform: translateY(0px) scale(.99); }
    .dpadBtn svg{
      width: 20px;
      height: 20px;
      fill:none;
      stroke: rgba(255,255,255,.92);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .help{
      font-size: 12.5px;
      color: var(--sub);
      line-height:1.45;
    }

    .aiPanel{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .aiHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .aiTitle{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .aiStatus{
      font-size: 12px;
      color: var(--sub);
    }
    .aiGrid{
      display:grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }
    .aiMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      font-size: 12.5px;
      color: var(--sub);
    }
    .aiMeta strong{
      color: var(--text);
      font-weight: 700;
      letter-spacing:.2px;
    }
    .aiResult{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      padding: 12px;
      display:grid;
      gap: 6px;
    }
    .aiResult strong{
      font-size: 16px;
      letter-spacing:.2px;
    }
    .aiReason{
      font-size: 12.5px;
      color: var(--sub);
    }

    @media (max-width: 860px){
      .topbar .row{ width:100%; justify-content:flex-start; }
      .dropdown{ flex:1 1 auto; }
      .aiMeta{ flex-direction:column; align-items:flex-start; }
      .dpadBtn{ min-height: 52px; }
    }

    @media (prefers-reduced-motion: reduce){
      .tile, .btn, .dpadBtn, .ddBtn { transition:none !important; }
      .tile.pop{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="safe">
    <div class="app">
      <div class="topbar">
        <div>
          <h1 class="title">2048</h1>
          <p class="sub">方向键/WASD 或右侧按钮操作。</p>
        </div>
        <div class="row">
          <!-- 自绘下拉：替代原生 select，展开风格一致 -->
          <div class="dropdown" id="layoutDropdown">
            <b>布局</b>
            <button class="ddBtn" id="ddBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span class="ddValue" id="ddValue">4 × 4</span>
              <span class="ddChevron" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
              </span>
            </button>

            <div class="ddMenu" id="ddMenu" role="listbox" aria-label="选择布局">
              <button class="ddItem" type="button" role="option" data-size="4" aria-selected="true">
                <span>4 × 4</span>
                <span class="ddMark" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
                </span>
              </button>
              <button class="ddItem" type="button" role="option" data-size="5" aria-selected="false">
                <span>5 × 5</span>
                <span class="ddMark" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
                </span>
              </button>
              <button class="ddItem" type="button" role="option" data-size="6" aria-selected="false">
                <span>6 × 6</span>
                <span class="ddMark" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
                </span>
              </button>
            </div>
          </div>

          <button id="newBtn" class="btn">新游戏</button>
        </div>
      </div>

      <div class="content">
        <div class="panel leftWrap">
          <div class="row">
            <div class="chip"><b>得分</b><span id="score">0</span></div>
            <div class="chip"><b>最高</b><span id="best">0</span></div>
          </div>

          <div class="boardShell">
            <div class="board" id="board" aria-label="2048 棋盘" role="application">
              <div class="gridBg" id="gridBg"></div>
              <div class="tiles" id="tiles"></div>

              <div class="overlay" id="overlay">
                <div class="overlayCard">
                  <h3 id="ovTitle">游戏结束</h3>
                  <p id="ovText">没有可移动的空间了。</p>
                  <div class="overlayActions">
                    <button class="btn" id="keepBtn" type="button">继续</button>
                    <button class="btn" id="retryBtn" type="button">再来一局</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel rightWrap">
          <div class="row">
            <div class="chip" style="flex:1 1 auto;">
              <b>目标</b>
              <span id="targetText">2048</span>
            </div>
          </div>

          <div class="aiPanel">
            <div class="aiHeader">
              <h3 class="aiTitle">AI 提示</h3>
              <span class="aiStatus" id="aiStatus">待命</span>
            </div>
            <div class="aiGrid">
              <div class="aiMeta">
                <span>模型</span>
                <strong id="aiModel">deepseek-chat</strong>
              </div>
            </div>
            <div class="aiResult" aria-live="polite">
              <strong id="aiMove">下一步：—</strong>
              <div class="aiReason" id="aiReason">理由：—</div>
            </div>
            <button class="btn" id="aiBtn" type="button">获取建议</button>
          </div>

          <div class="dpad" aria-label="方向控制">
            <div class="spacer"> </div>
            <button class="dpadBtn" id="upBtn" aria-label="上" type="button">
              <svg viewBox="0 0 24 24"><path d="M12 5l-7 7"></path><path d="M12 5l7 7"></path><path d="M12 5v14"></path></svg>
            </button>
            <div class="spacer"> </div>

            <button class="dpadBtn" id="leftBtn" aria-label="左" type="button">
              <svg viewBox="0 0 24 24"><path d="M5 12l7-7"></path><path d="M5 12l7 7"></path><path d="M5 12h14"></path></svg>
            </button>
            <div class="spacer"> </div>
            <button class="dpadBtn" id="rightBtn" aria-label="右" type="button">
              <svg viewBox="0 0 24 24"><path d="M19 12l-7-7"></path><path d="M19 12l-7 7"></path><path d="M19 12H5"></path></svg>
            </button>

            <div class="spacer"> </div>
            <button class="dpadBtn" id="downBtn" aria-label="下" type="button">
              <svg viewBox="0 0 24 24"><path d="M12 19l-7-7"></path><path d="M12 19l7-7"></path><path d="M12 5v14"></path></svg>
            </button>
            <div class="spacer"> </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 2048 核心逻辑（支持 N×N）
    // =========================
    const TARGET = 2048;

    const els = {
      // 自绘下拉
      layoutDropdown: document.getElementById("layoutDropdown"),
      ddBtn: document.getElementById("ddBtn"),
      ddValue: document.getElementById("ddValue"),
      ddMenu: document.getElementById("ddMenu"),
      ddItems: Array.from(document.querySelectorAll(".ddItem")),

      newBtn: document.getElementById("newBtn"),
      score: document.getElementById("score"),
      best: document.getElementById("best"),
      targetText: document.getElementById("targetText"),
      board: document.getElementById("board"),
      gridBg: document.getElementById("gridBg"),
      tiles: document.getElementById("tiles"),

      overlay: document.getElementById("overlay"),
      ovTitle: document.getElementById("ovTitle"),
      ovText: document.getElementById("ovText"),
      keepBtn: document.getElementById("keepBtn"),
      retryBtn: document.getElementById("retryBtn"),

      upBtn: document.getElementById("upBtn"),
      downBtn: document.getElementById("downBtn"),
      leftBtn: document.getElementById("leftBtn"),
      rightBtn: document.getElementById("rightBtn"),

      aiModel: document.getElementById("aiModel"),
      aiBtn: document.getElementById("aiBtn"),
      aiStatus: document.getElementById("aiStatus"),
      aiMove: document.getElementById("aiMove"),
      aiReason: document.getElementById("aiReason"),
    };

    let size = 4;
    let board = [];
    let score = 0;
    let best = 0;
    let wonShown = false;

    const rand = (n) => Math.floor(Math.random() * n);

    function bestKey(n){ return `best_2048_${n}`; }
    function loadBest(n){
      const v = Number(localStorage.getItem(bestKey(n)) || "0");
      return Number.isFinite(v) ? v : 0;
    }
    function saveBest(n, v){ localStorage.setItem(bestKey(n), String(v)); }

    function setSize(n){
      size = n;
      document.documentElement.style.setProperty("--size", String(size));
      best = loadBest(size);
      updateHUD();
      buildGridBackground();
      initGame();
      requestAnimationFrame(updateSizing);
      setDropdownSelected(n);
    }

    function initGame(){
      board = Array.from({length: size}, () => Array(size).fill(0));
      score = 0;
      wonShown = false;
      hideOverlay();
      spawnTile();
      spawnTile();
      render(true);
      updateHUD();
    }

    function emptyCells(){
      const cells = [];
      for (let r=0; r<size; r++){
        for (let c=0; c<size; c++){
          if (board[r][c] === 0) cells.push([r,c]);
        }
      }
      return cells;
    }

    function spawnTile(){
      const empties = emptyCells();
      if (!empties.length) return false;
      const [r,c] = empties[rand(empties.length)];
      board[r][c] = Math.random() < 0.9 ? 2 : 4;
      return {r,c};
    }

    function linesFor(dir){
      const lines = [];
      if (dir === "left" || dir === "right"){
        for (let r=0; r<size; r++){
          const line = [];
          for (let c=0; c<size; c++){
            const cc = (dir === "left") ? c : (size - 1 - c);
            line.push([r, cc]);
          }
          lines.push(line);
        }
      } else {
        for (let c=0; c<size; c++){
          const line = [];
          for (let r=0; r<size; r++){
            const rr = (dir === "up") ? r : (size - 1 - r);
            line.push([rr, c]);
          }
          lines.push(line);
        }
      }
      return lines;
    }

    function collapse(values){
      const v = values.filter(x => x !== 0);
      let gained = 0;
      for (let i=0; i<v.length-1; i++){
        if (v[i] !== 0 && v[i] === v[i+1]){
          v[i] *= 2;
          gained += v[i];
          v[i+1] = 0;
          i++;
        }
      }
      const merged = v.filter(x => x !== 0);
      while (merged.length < size) merged.push(0);
      return { merged, gained };
    }

    function move(dir){
      if (els.overlay.classList.contains("show")) return;

      let changed = false;
      let gainedTotal = 0;

      const lines = linesFor(dir);
      for (const line of lines){
        const before = line.map(([r,c]) => board[r][c]);
        const { merged, gained } = collapse(before);
        gainedTotal += gained;

        for (let i=0; i<line.length; i++){
          const [r,c] = line[i];
          if (board[r][c] !== merged[i]) changed = true;
          board[r][c] = merged[i];
        }
      }

      if (!changed) return;

      score += gainedTotal;
      if (score > best){
        best = score;
        saveBest(size, best);
      }

      const spawned = spawnTile();
      render(spawned);
      updateHUD();

      const maxTile = maxValue();
      if (!wonShown && maxTile >= TARGET){
        wonShown = true;
        showOverlay("已达成目标", `你已合成 ≥ ${TARGET} 的数字。可以继续挑战更高分。`);
      } else if (isGameOver()){
        showOverlay("游戏结束", "没有可移动的空间了。");
      }
    }

    function maxValue(){
      let m = 0;
      for (let r=0; r<size; r++){
        for (let c=0; c<size; c++){
          m = Math.max(m, board[r][c]);
        }
      }
      return m;
    }

    function isGameOver(){
      if (emptyCells().length) return false;
      for (let r=0; r<size; r++){
        for (let c=0; c<size; c++){
          const v = board[r][c];
          if ((r+1<size && board[r+1][c] === v) || (c+1<size && board[r][c+1] === v)) return false;
        }
      }
      return true;
    }

    // =========================
    // 渲染与布局
    // =========================
    function buildGridBackground(){
      els.gridBg.innerHTML = "";
      const total = size * size;
      for (let i=0; i<total; i++){
        const d = document.createElement("div");
        d.className = "cell";
        els.gridBg.appendChild(d);
      }
    }

    function updateSizing(){
      const rect = els.tiles.getBoundingClientRect();
      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--gap")) || 10;
      const cell = (rect.width - gap*(size-1)) / size;
      document.documentElement.style.setProperty("--cell", `${cell}px`);
      render(false);
    }

    function render(spawned){
      els.tiles.innerHTML = "";

      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--gap")) || 10;
      const cell = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cell")) || 80;

      for (let r=0; r<size; r++){
        for (let c=0; c<size; c++){
          const v = board[r][c];
          if (!v) continue;

          const tile = document.createElement("div");
          tile.className = "tile";
          tile.dataset.v = String(v);

          const digits = String(v).length;
          tile.dataset.digits = String(digits);

          const x = c * (cell + gap);
          const y = r * (cell + gap);
          tile.style.setProperty("--x", `${x}px`);
          tile.style.setProperty("--y", `${y}px`);

          const n = document.createElement("div");
          n.className = "n";
          n.textContent = String(v);
          tile.appendChild(n);

          if (spawned && spawned.r === r && spawned.c === c) tile.classList.add("pop");

          els.tiles.appendChild(tile);
        }
      }
    }

    function updateHUD(){
      els.score.textContent = String(score);
      els.best.textContent = String(best);
      els.targetText.textContent = String(TARGET);
    }

    function formatBoard(){
      return board.map(row => row.map(v => String(v).padStart(4, " ")).join(" ")).join("\n");
    }

    function setAiStatus(text){ els.aiStatus.textContent = text; }
    function setAiResult(move, reason){
      els.aiMove.textContent = `下一步：${move || "—"}`;
      els.aiReason.textContent = `理由：${reason || "—"}`;
    }

    const DEEPSEEK_API_KEY = "sk-2930ce6bb4c44d49a03dc2c7f564dfdf";

    async function fetchSuggestion(){
      const model = (els.aiModel?.textContent || "deepseek-chat").trim();
      setAiStatus("请求中…");
      els.aiBtn.disabled = true;
      try{
        const payload = {
          model,
          messages: [
            {
              role: "system",
              content: "你是2048助手，只回答JSON。字段：move（up/down/left/right），reason（不超过20字）。"
            },
            {
              role: "user",
              content: `棋盘大小:${size}。得分:${score}。棋盘(每行):\n${formatBoard()}\n请给出下一步操作与理由。`
            }
          ],
          temperature: 0.2
        };

        const resp = await fetch("https://api.deepseek.com/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok){
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const content = data?.choices?.[0]?.message?.content || "";
        let move = "";
        let reason = "";
        try{
          const parsed = JSON.parse(content);
          move = parsed.move || "";
          reason = parsed.reason || "";
        } catch (e){
          const matchMove = content.match(/(up|down|left|right)/i);
          move = matchMove ? matchMove[1].toLowerCase() : "";
          reason = content.replace(/[\s\S]*reason[:：]?\s*/i, "").trim();
        }
        setAiResult(move, reason.slice(0, 20));
        setAiStatus("完成");
      } catch (err){
        console.error(err);
        setAiStatus("请求失败");
      } finally {
        els.aiBtn.disabled = false;
      }
    }

    // =========================
    // 覆盖层提示
    // =========================
    function showOverlay(title, text){
      els.ovTitle.textContent = title;
      els.ovText.textContent = text;
      els.overlay.classList.add("show");
    }
    function hideOverlay(){ els.overlay.classList.remove("show"); }

    // =========================
    // 自绘下拉逻辑
    // =========================
    function openDropdown(){
      els.layoutDropdown.classList.add("open");
      els.ddBtn.setAttribute("aria-expanded", "true");
    }
    function closeDropdown(){
      els.layoutDropdown.classList.remove("open");
      els.ddBtn.setAttribute("aria-expanded", "false");
    }
    function toggleDropdown(){
      const isOpen = els.layoutDropdown.classList.contains("open");
      isOpen ? closeDropdown() : openDropdown();
    }
    function setDropdownSelected(n){
      els.ddValue.textContent = `${n} × ${n}`;
      els.ddItems.forEach(btn => {
        const s = Number(btn.dataset.size);
        btn.setAttribute("aria-selected", s === n ? "true" : "false");
      });
    }

    els.ddBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    els.ddItems.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const n = Number(btn.dataset.size);
        closeDropdown();
        setSize(n);
        // 选完回到按钮，便于键盘继续操作
        els.ddBtn.focus();
      });
    });

    // 点击空白处关闭
    document.addEventListener("click", () => closeDropdown());

    // ESC 关闭
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && els.layoutDropdown.classList.contains("open")){
        e.preventDefault();
        closeDropdown();
        els.ddBtn.focus();
      }
    });

    // 下拉展开时阻止点击菜单内部触发外层关闭（已在 item/btn stopPropagation）
    els.ddMenu.addEventListener("click", (e) => e.stopPropagation());

    // =========================
    // 键盘、按钮、滑动
    // =========================
    function onKeyDown(e){
      const k = e.key;
      const map = {
        ArrowUp: "up", ArrowDown: "down", ArrowLeft: "left", ArrowRight: "right",
        w: "up", s: "down", a: "left", d: "right",
        W: "up", S: "down", A: "left", D: "right",
      };
      if (map[k]){
        e.preventDefault();
        move(map[k]);
      }
      if (k === "Escape" && els.overlay.classList.contains("show")){
        hideOverlay();
      }
    }

    let touchStart = null;
    function onTouchStart(e){
      if (!e.touches || !e.touches.length) return;
      const t = e.touches[0];
      touchStart = { x: t.clientX, y: t.clientY };
    }
    function onTouchEnd(e){
      if (!touchStart) return;
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      if (!t) return;

      const dx = t.clientX - touchStart.x;
      const dy = t.clientY - touchStart.y;
      const adx = Math.abs(dx), ady = Math.abs(dy);

      const threshold = 28;
      if (Math.max(adx, ady) < threshold) return;

      if (adx > ady) move(dx > 0 ? "right" : "left");
      else move(dy > 0 ? "downtottom" : "top"); // 先占位避免误触（下面立刻修正）
      touchStart = null;
    }
    // 修正上面占位（避免你复制时漏改）：实际应为 down/up
    function onTouchEndFixed(e){
      if (!touchStart) return;
      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      if (!t) return;

      const dx = t.clientX - touchStart.x;
      const dy = t.clientY - touchStart.y;
      const adx = Math.abs(dx), ady = Math.abs(dy);

      const threshold = 28;
      if (Math.max(adx, ady) < threshold) return;

      if (adx > ady) move(dx > 0 ? "right" : "left");
      else move(dy > 0 ? "down" : "up");
      touchStart = null;
    }

    els.newBtn.addEventListener("click", initGame);

    els.upBtn.addEventListener("click", () => move("up"));
    els.downBtn.addEventListener("click", () => move("down"));
    els.leftBtn.addEventListener("click", () => move("left"));
    els.rightBtn.addEventListener("click", () => move("right"));

    els.keepBtn.addEventListener("click", hideOverlay);
    els.retryBtn.addEventListener("click", initGame);

    els.aiBtn.addEventListener("click", fetchSuggestion);

    window.addEventListener("keydown", onKeyDown, { passive: false });
    window.addEventListener("resize", () => requestAnimationFrame(updateSizing));

    els.board.addEventListener("touchstart", onTouchStart, { passive: true });
    els.board.addEventListener("touchend", onTouchEndFixed, { passive: true });

    // =========================
    // 启动
    // =========================
    (function boot(){
      setSize(4);
      requestAnimationFrame(updateSizing);
    })();
  </script>
</body>
</html>
